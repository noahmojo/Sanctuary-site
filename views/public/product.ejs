<%- include('../partials/header', { settings, title: product.name }) %>

<section class="py-16">
  <div class="max-w-6xl mx-auto px-6">
    <a href="/shop" class="text-neutral-500 hover:text-neutral-700 text-sm mb-8 inline-block">‚Üê Back to Shop</a>
    
    <div class="grid md:grid-cols-2 gap-12">
      <!-- Photos -->
      <div>
        <div class="aspect-square rounded-2xl overflow-hidden bg-neutral-100 mb-4" id="main-image">
          <% if (product.photos && product.photos.length > 0) { %>
            <img src="<%= product.photos[0] %>" alt="<%= product.name %>" class="w-full h-full object-cover" id="main-photo">
          <% } else { %>
            <div class="w-full h-full flex items-center justify-center text-neutral-300">
              <svg class="w-24 h-24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            </div>
          <% } %>
        </div>
        <% if (product.photos && product.photos.length > 1) { %>
          <div class="grid grid-cols-4 gap-2">
            <% product.photos.forEach((photo, i) => { %>
              <button onclick="document.getElementById('main-photo').src='<%= photo %>'" class="aspect-square rounded-lg overflow-hidden bg-neutral-100 hover:ring-2 hover:ring-emerald-500 transition">
                <img src="<%= photo %>" alt="<%= product.name %>" class="w-full h-full object-cover">
              </button>
            <% }) %>
          </div>
        <% } %>
      </div>
      
      <!-- Details -->
      <div>
        <% if (product.category) { %>
          <p class="text-emerald-600 text-sm font-medium mb-2"><%= product.category %></p>
        <% } %>
        <h1 class="text-3xl font-light mb-4"><%= product.name %></h1>
        <p class="text-2xl font-medium mb-6">$<%= (product.price / 100).toFixed(2) %></p>
        
        <% if (product.description) { %>
          <div class="prose prose-neutral mb-8">
            <p class="text-neutral-600 leading-relaxed whitespace-pre-line"><%= product.description %></p>
          </div>
        <% } %>
        
        <% if (product.inventory !== null && product.inventory <= 5 && product.inventory > 0) { %>
          <p class="text-amber-600 text-sm mb-4">Only <%= product.inventory %> left in stock!</p>
        <% } %>
        
        <% if (product.inventory === 0) { %>
          <button disabled class="w-full bg-neutral-200 text-neutral-500 py-4 rounded-xl font-medium cursor-not-allowed">Out of Stock</button>
        <% } else { %>
          <div class="flex gap-4 mb-6">
            <div class="flex items-center border border-neutral-200 rounded-xl">
              <button onclick="updateQty(-1)" class="px-4 py-3 text-neutral-500 hover:text-neutral-900 transition">‚àí</button>
              <input type="number" id="quantity" value="1" min="1" class="w-16 text-center border-0 focus:ring-0">
              <button onclick="updateQty(1)" class="px-4 py-3 text-neutral-500 hover:text-neutral-900 transition">+</button>
            </div>
            <button onclick="addToCart()" id="add-btn" class="flex-1 bg-emerald-600 text-white py-4 rounded-xl font-medium hover:bg-emerald-700 transition">Add to Cart</button>
          </div>
        <% } %>
        
        <div class="border-t border-neutral-100 pt-6 mt-6">
          <p class="text-neutral-500 text-sm">ü¶ô Every purchase supports the animals at Sierra Alpaca Sanctuary</p>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
function updateQty(change) {
  const input = document.getElementById('quantity');
  const newVal = Math.max(1, parseInt(input.value) + change);
  input.value = newVal;
}

async function addToCart() {
  const btn = document.getElementById('add-btn');
  const quantity = parseInt(document.getElementById('quantity').value);
  btn.textContent = 'Adding...';
  btn.disabled = true;
  
  try {
    const res = await fetch('/cart/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ productId: '<%= product.id %>', quantity })
    });
    const data = await res.json();
    if (data.success) {
      btn.textContent = 'Added! ‚úì';
      btn.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
      btn.classList.add('bg-emerald-700');
      // Update cart count in nav
      const cartBadge = document.querySelector('nav .bg-emerald-600');
      if (cartBadge) {
        cartBadge.textContent = data.cartCount;
      } else {
        location.reload();
      }
      setTimeout(() => {
        btn.textContent = 'Add to Cart';
        btn.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
        btn.classList.remove('bg-emerald-700');
        btn.disabled = false;
      }, 2000);
    }
  } catch (e) {
    btn.textContent = 'Error - Try Again';
    btn.disabled = false;
  }
}
</script>

<%- include('../partials/footer', { settings }) %>
